<!DOCTYPE html>
<html>

<head>
    <title>Cleaning Motion...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
        const SB_URL = "https://jftthfniwfarxyisszjh.supabase.co/rest/v1/notifications_log";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmdHRoZm5pd2Zhcnh5aXNzempoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDkzMjEsImV4cCI6MjA4MzI4NTMyMX0.gPUAizcb955wy6-c_krSAx00_0VNsZc4J3C0I2tmrnw";

        async function logToDb(step, details) {
            try {
                await fetch(SB_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SB_KEY,
                        'Authorization': `Bearer ${SB_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        stop_id: 'RESET_TOOL',
                        route_id: 'DEBUG',
                        alert_level: 0,
                        metadata: {
                            step,
                            details,
                            ua: navigator.userAgent,
                            project: 'MotionAG',
                            timestamp: new Date().toISOString()
                        }
                    })
                });
            } catch (e) { console.error("Log failed", e); }
        }

        async function nuke() {
            const log = (msg) => {
                document.body.innerHTML += `<div>${msg}</div>`;
                console.log(msg);
            };

            log("ðŸ§¹ Starting Deep Clean (v2)...");
            await logToDb('RESET_START', { href: window.location.href });

            // 1. Unregister Service Workers
            if ('serviceWorker' in navigator) {
                try {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    for (const reg of regs) {
                        await reg.unregister();
                        log(`ðŸ—‘ï¸ Unregistered SW: ${reg.scope}`);
                    }
                } catch (e) {
                    log(`âŒ SW Error: ${e.message}`);
                }
            }

            // 2. Clear Caches (All of them)
            if ('caches' in window) {
                try {
                    const keys = await caches.keys();
                    for (const key of keys) {
                        await caches.delete(key);
                        log(`ðŸ—‘ï¸ Deleted Cache: ${key}`);
                    }
                } catch (e) {
                    log(`âŒ Cache Error: ${e.message}`);
                }
            }

            // 3. Clear Storage
            localStorage.clear();
            sessionStorage.clear();
            log("ðŸ—‘ï¸ Cleared Local/Session Storage");

            await logToDb('RESET_COMPLETE', { success: true });

            log("âœ… DONE! Redirecting to v1.5.17.9.2...");

            setTimeout(() => {
                window.location.replace('/MotionAG/?t=' + Date.now() + '&ver=17.9.2');
            }, 3000);
        }

        window.onload = nuke;
    </script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            background: #000;
            color: #0f0;
        }

        div {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>Resetting App...</h1>
</body>

</html>