<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Bus Debug</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            max-width: 600px;
            mx-auto;
            background: #f0f0f0;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            margin-top: 0;
            font-size: 1.5rem;
        }

        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            margin: 5px 0;
            cursor: pointer;
        }

        button:active {
            opacity: 0.8;
        }

        button.secondary {
            background: #64748b;
        }

        button.danger {
            background: #ef4444;
        }

        .status {
            font-family: monospace;
            background: #1e293b;
            color: #4ade80;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
    </style>
</head>

<body>
    <h1>üõ†Ô∏è Motion Debugger</h1>

    <div class="card">
        <h3>1. Status Check</h3>
        <div class="row"><span>Permission:</span> <b id="perm-status">---</b></div>
        <div class="row"><span>SW Active:</span> <b id="sw-status">---</b></div>
        <div class="row"><span>Context:</span> <b id="context-status">---</b></div>
        <button class="secondary" onclick="checkStatus()">Refresh Status</button>
    </div>

    <div class="card">
        <h3>2. Actions</h3>
        <button onclick="reqPerm()">üîë Request Permission</button>
        <button onclick="testWindowNotif()">üì± Test Local Notification (Window)</button>
        <button onclick="testSWNotif()">‚öôÔ∏è Test SW Notification (Worker)</button>
    </div>

    <div class="card">
        <h3>3. Logs</h3>
        <div id="logs" class="status">Ready...</div>
        <button class="danger" onclick="document.getElementById('logs').innerHTML=''">Clear Logs</button>
    </div>

    <script>
        function log(msg) {
            const el = document.getElementById('logs');
            el.innerHTML = `> ${msg}\n${el.innerHTML}`;
            console.log(msg);
        }

        async function checkStatus() {
            // Permission
            document.getElementById('perm-status').innerText = Notification.permission;

            // SW
            const reg = await navigator.serviceWorker.getRegistration();
            document.getElementById('sw-status').innerText = reg ? (reg.active ? 'Active ‚úÖ' : 'Waiting ‚è≥') : 'Missing ‚ùå';

            // Context
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            document.getElementById('context-status').innerText = isStandalone ? 'PWA (Installed)' : 'Browser Tab';

            log('Status refreshed');
        }

        function reqPerm() {
            Notification.requestPermission().then(p => {
                log(`Permission result: ${p}`);
                checkStatus();
            });
        }

        function testWindowNotif() {
            try {
                if (Notification.permission !== 'granted') return log('‚ùå Permission not granted');
                new Notification('Test Window', { body: 'This is from the Main Thread' });
                log('‚úÖ Window Notification sent');
            } catch (e) {
                log(`‚ùå Window Error: ${e.message}`);
            }
        }

        async function testSWNotif() {
            try {
                const reg = await navigator.serviceWorker.getRegistration();
                if (!reg || !reg.active) return log('‚ùå No Active Service Worker');

                // We use showNotification from the registration directly
                await reg.showNotification('Test SW', {
                    body: 'This is from the Service Worker Registration',
                    icon: '/MotionAG/pwa-192x192.png',
                    tag: 'debug-sw'
                });
                log('‚úÖ SW Notification trigger sent');
            } catch (e) {
                log(`‚ùå SW Error: ${e.message}`);
            }
        }

        // Init
        checkStatus();
    </script>
</body>

</html>